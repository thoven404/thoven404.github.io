# 基础篇

## TCP/IP 网络模型

1. 网络通信用于不同设备间的进程通信。

2. TCP/IP 网络通常是由上到下分成4层，分别是应用层，传输层，网络层，网络接口层。

3. **应用层**：我们的电脑或者手机使用的软件都是在应用层实现，当两个不同设备的应用需要通信的时候，应用就把应用数据传给下一层，也就是传输层。  
    应用层只需要专注于为用户提供应用功能，比如 HTTP、FTP、Telnet、DNS、SMTP等。

4. **传输层**：应用层的数据包会传给传输层，传输层是为应用层提供网络支持的。  
    在传输层有两个传输协议，分别是 TCP 和 UDP 。

    **TCP** 的全称叫传输控制协议（Transmission Control Protocol），大部分应用使用的正是 TCP 传输层协议，比如 HTTP 应用层协议。TCP 相比 UDP 多了很多特性，比如流量控制、超时重传、拥塞控制等，这些都是为了保证数据包能可靠地传输给对方。

    **UDP** 相对来说就很简单，简单到只负责发送数据包，不保证数据包是否能抵达对方，但它实时性相对更好，传输效率也高。当然，UDP 也可以实现可靠传输，把 TCP 的特性在应用层上实现就可以，不过要实现一个商用的可靠 UDP 传输协议，也不是一件简单的事情。

    应用需要传输的数据可能会非常大，当传输层的数据包大小超过 MSS（TCP 最大报文段长度），就要将数据包分块，这样即使中途有一个分块丢失或损坏了，只需要重新发送这一个分块，而不用重新发送整个数据包。在 TCP 协议中，我们把每个分块称为一个 TCP 段（TCP Segment）。

    同一台设备商可能会有很多应用在接受或者传输数据，因此需要有一个编号将应用区分开来，这个编号就是**端口**。  
    由于传输层的报文中会携带端口号，因此接收方可以识别出该报文是发送给哪个应用。

5. **网络层**：传输层作为应用间数据传输的媒介，帮助实现应用到应用的通信，而实际的传输功能就交给下一层，也就是网络层（Internet Layer）。  

    网络层最常使用的是 **IP 协议**（Internet Protocol），IP 协议会将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文，如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会再次进行分片，得到一个即将发送到网络的 IP 报文。  
    我们一般用 IP 地址给设备进行编号，对于 IPv4 协议， IP 地址共 32 位，分成了四段（比如，192.168.100.1），每段是 8 位。需要将 IP 地址分成两种意义：
    - 一个是**网络号**，负责标识该 IP 地址是属于哪个「子网」的；
    - 一个是**主机号**，负责标识同一「子网」下的不同主机。

    配合**子网掩码**可以算出 IP 地址 的网络号和主机号：将 IP 地址与子网掩码进行按位与运算，就可以得到网络号；将子网掩码取反后与 IP 地址进行按位与运算，就可以得到主机号。  
    在寻址的过程中，先匹配到相同的网络号（表示要找到同一个子网），才会去找对应的主机。

    除了寻址能力， IP 协议还有另一个重要的能力就是**路由**。路由器寻址工作中，就是要找到目标地址的子网，找到后进而把数据包转发给对应的网络内的设备。

    IP 协议的寻址作用是告诉我们去往下一个目的地该朝哪个方向走，路由则是根据「下一个目的地」选择路径。寻址更像在导航，路由更像在操作方向盘。

6. **网络接口层**：网络接口层（Link Layer）在 IP 头部的前面加上 MAC 头部，并封装成数据帧（Data frame）发送到网络上。

    MAC 头部是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息，我们可以通过 ARP 协议获取对方的 MAC 地址。

    **以太网**：一种在「局域网」内，把附近的设备连接起来，使它们之间可以进行通讯的技术。电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。

    网络接口层主要为网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。

7. 网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。

## 当键入网址后，到网页显示，其间发生了什么
流程：
- 解析 URL ，确定 Web 服务器和文件名，根据这些信息生成发送给 Web 服务器的 HTTP 请求消息。
- 通过 DNS 域名解析，查询服务器对应的 IP 地址。
- 由操作系统中的**协议栈**负责 HTTP 的传输工作
    - 应用程序（浏览器）通过调用 Socket 库委托协议栈工作。
    - 协议栈的上半部分有两块，分别是 TCP 和 UDP 协议，负责收发数据。（HTTP 是基于 TCP 协议传输的）
    - 协议栈的下半部分是由 IP 协议控制网络包收发工作。
    - IP 下面的网卡驱动程序负责控制网卡硬件。
    - 最下面的网卡负责完成实际的收发工作。


1. 第一步工作是对 `URL` 进行解析，从而生成发送给 `Web` 服务器的请求信息。
    
    对 URL 进行解析之后，浏览器确定了 Web 服务器和文件名，接下来就是根据这些信息来生成 HTTP 请求消息了。

2. 通过浏览器解析 URL 并生成 HTTP 消息后，需要委托操作系统将消息发送给 Web 服务器。
    
    在发送之前，需要查询服务器域名对应的 IP 地址，因为委托操作系统发送消息时，必须提供通信对象的 IP 地址。

    DNS 服务器保存了 Web 服务器域名与 IP 的对应关系。  
    DNS 中的域名都是用句点来分隔的，比如 `www.server.com` ，这里的句点代表了不同层次之间的界限。越靠右的位置表示其层级越高。

    通过 DNS 域名解析，就查到了服务器域名的 IP 地址。

3. 通过 DNS 获取到 IP 后，就可以把 HTTP 的传输工作交给操作系统中的**协议栈**。

    应用程序（浏览器）通过调用 Socket 库，来委托协议栈工作。
    
    协议栈的上半部分有两块，分别是负责收发数据的 TCP 和 UDP 协议，这两个传输协议会接受应用层的委托执行收发数据的操作。  
    协议栈的下面一半是用 IP 协议控制网络包收发操作。

    IP 下面的网卡驱动程序负责控制网卡硬件，最下面的网卡负责实际的收发操作，也就是对网线中的信号执行发送和接收操作。

## TCP

1. HTTP 是基于 TCP 协议传输的。在HTTP消息前加上 TCP 包头。
    TCP 传输数据之前，要先三次握手建立连接，保证双方都有发送和接受的能力。

## IP
1. TCP 模块在执行连接、收发、断开等各阶段操作时，都需要委托 IP 模块将数据封装成网络包发送给通信对象。

2. IP 协议里需要有源地址 IP 和 目标地址 IP。
    当存在多个网卡时，填写源 IP 地址就需要判断到底应该填写哪个地址，这个判断相当于在多块网卡中判断应该使用哪块网卡来发送包。

## MAC
1. 生成了 IP 头部之后，接下来网络包还需要在 IP 头部前面加上 MAC 头部。
    在 MAC 包头里需要发送方 MAC 地址和接收方目标 MAC 地址，用于两点之间的传输。
    通过 ARP 协议可以找到路由器的 AMC 地址。

## 网卡

## 交换机
1. 交换机根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口。

## 路由器
因为路由器是基于 IP 设计的，俗称三层网络设备，路由器的各个端口都具有 MAC 地址和 IP 地址；
而交换机是基于以太网设计的，俗称二层网络设备，交换机的端口不具有 MAC 地址。

完成包接收操作之后，路由器就会去掉包开头的 MAC 头部。MAC 头部的作用就是将包送达路由器，其中的接收方 MAC 地址就是路由器端口的 MAC 地址。

# Linux 系统是如何收发网络包的

为了使得多种设备能通过网络相互通信，和为了解决各种不同设备在网络互联中的兼容性问题，国际标准化组织指定了 OSI 网络模型，该模型主要有7层，分别是应用层、表示层、会话层、传输层网络层、数据链路层以及物理层。
事实上比较常见及实用的是四层模型，即 TCP/IP 网络模型，Linux系统正是按照这套网络模型来实现网络协议栈的。

TCP/IP 网络模型共有4层，分别是应用层、传输层、网络层和网络接口层：
- 应用层：负责向用户提供一组应用程序，比如 HTTP、DNS、FTP 等；
- 传输层：负责端到端的通信，比如 TCP、UDP 等；
- 网络层：负责网络包的封装、分片、路由、转发，比如 IP、ICMP 等；
- 网络接口层：负责网络包在物理网络中的传输，比如网络包的封帧、MAC 寻址、差错检测，以及通过网卡传输网络帧等。


传输层：给应用数据前面增加 TCP 头；
网络层：给 TCP 数据包前面增加 IP 层；
网络接口层：给 IP 数据包前后分别增加帧头和帧尾。



